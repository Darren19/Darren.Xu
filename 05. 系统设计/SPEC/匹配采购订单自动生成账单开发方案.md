# 匹配采购订单自动生成账单

## 0. 账号和环境信息

选项 | 内容
---|---
开发环境 | 雅耶SANDBOX 
用户名	| 
密码	| 
密保答案 | 

# 1. 需求基本信息

信息选项 | 内容
---|---
优先级 | 高 
需求提交日期 | 2019-10-21 
需求完成日期 |  

# 2. 需求概述

跟单人员和财务人员在核对供应商开具的采购发票和采购合同的内容时，工作量巨大，而且容易出错。处理不及时，或者出错，就会影响公司的出口退税。为了减轻用户的手工工作量，同时提高匹配的准确性，所以有了本次开发方案。

供应商提供的纸质采购发票，需要扫描并导入到NS中记录下来。这部分工作由雅耶的开发人员完成。云合负责根据导入的发票记录，匹配系统内的采购订单，并自动生成账单。

# 3. 工时

预估工时 | 确认工时
---|---
小时 | 小时 

# 4. 详细需求

## 4.1 系统发票记录

导入的发票记录字段分为表体和明细行字段。

需要记录的表体字段为：

|   字段名称   |  格式  |             备注             |
| :----------: | :----: | :--------------------------: |
|    子公司    |  列表  |                              |
|   发票号码   |  文本  |                              |
|   开票日期   |  日期  |                              |
|    供应商    |  列表  |                              |
| 纳税人识别号 |  文本  |                              |
|   采购合同   |  文本  |   用于匹配系统内的采购订单   |
|    已匹配    | 单选框 | 用于标记是否已经匹配生成账单 |

需要记录的明细行字段为：

| 字段名称 | 格式 |        备注        |
| :------: | :--: | :----------------: |
| 开票品名 | 文本 |                    |
| 规格型号 | 文本 |                    |
|   数量   | 小数 |                    |
|   单位   | 列表 | 从系统的单位中选取 |
|   单价   | 货币 |                    |
|   税额   | 货币 |                    |
|   金额   | 货币 |                    |

## 4.2 匹配操作

用户打开匹配界面后，点击【匹配发票】，系统自动载入所有还未匹配的发票记录，并根据采购合同号匹配系统内的采购订单，并展示匹配结果。如果一次性载入所有未匹配的发票记录会影响用户操作体验时，可以默认只载入固定数量的发票记录，例如10张。具体设置哪个数字，需要在测试的过程中确定下来。

系统根据表体中的【采购合同号】找到系统内的采购订单，然后匹配【供应商】和【纳税人识别号】字段，接着匹配明细行中的所有字段。在比较数量字段时，发票记录中的数量要与采购订单明细行中的未开票数量进行比较，而不是采购订单明细行的数量字段。如果上述的所有字段与采购订单全部匹配成功，则明细行以绿底显示，并默认勾选第一列的单选框。第一列的单选框，用于标识用户提交时是否生成账单。

（因为未到货的不能生成账单，所以要匹配的数量不是采购合同数量，而是已开票与已收货的数量之差。）

如果上述某些字段无法匹配，则系统将这些字段以黄底显示，提示用户去修改采购合同，或者要求供应商重开发票；并将第一列的单选框置为灰色，不允许用户勾选。

如果无法匹配的字段中，只有数量字段不能匹配，且发票记录数量小于采购订单未开票数量，此时允许用户勾选。这个例外，是因为存在供应商分批开票的业务场景。

用户点击【提交】，系统根据勾选的发票明细，生成采购订单对应的账单。账单状态默认为【待核准】。一张发票记录所有的明细行都必须勾选，不能有部分勾选的情况。只有明细行全部勾选的发票记录，系统才能够生成账单。生成账单后，系统勾选发票记录的【已匹配】字段。

## 4.3 其它要求

同一个货品，会向多个供应商采购，而且这些供应商针对此货品的开票品名可能会不一致。为了能够匹配，采购订单和账单明细中添加自定义字段【开票品名】，默认从货品的属性中带出来。如果带出来的开票品名与供应商的开票品名不一致，由开单员手工修改。

## 4.3 报表查询

用户可以根据报表查看，哪些导入的发票记录还没有匹配生成账单。

系统也可以自动发送邮件，提醒跟单员去匹配这些发票记录。

## 4.4 后续优化

在实际业务场景中，供应商会将多张采购合同的发票合并起来，只开一张纸质的采购发票。这种业务，本方案暂时无法直接处理。

现有的方案是，由跟单员线下在EXCEL中将发票记录拆分出来，一张采购合同对应一张发票记录；然后将这些发票记录，导入到系统中，再由系统进行上述的匹配过程。

后续可以针对这种业务场景，另外开发一个程序解决。

# 5 签字

| 上海朗探 | 上海云合 |
| -------- | :------- |
| 签字：   | 签字：   |
| 日期：   | 日期：   |